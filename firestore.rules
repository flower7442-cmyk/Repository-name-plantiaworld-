rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ========== 공통 함수 ==========

    // 로그인 여부 확인
    function isLoggedIn() {
      return request.auth != null;
    }

    // 본인 여부 확인
    function isOwner(uid) {
      return isLoggedIn() && request.auth.uid == uid;
    }

    // ⭐ 관리자 여부 확인 - 본인 Firebase UID로 교체하세요
    function isAdmin() {
      return isLoggedIn() && request.auth.uid in [
        'LIuwCkomQmf0iHf7QoBXs57OecI2'
      ];
    }

    // 해당 상품의 판매자 여부 확인
    function isProductSeller(productData) {
      return isLoggedIn() && request.auth.uid == productData.sellerId;
    }


    // ========== products 컬렉션 ==========
    match /products/{productId} {

      // 읽기: 누구나 가능 (비로그인도 상품 조회 가능)
      allow read: if true;

      // 등록: 로그인한 사용자만, sellerId는 반드시 본인 uid
      allow create: if isLoggedIn()
        && request.resource.data.sellerId == request.auth.uid
        && request.resource.data.title is string
        && request.resource.data.title.size() > 0
        && request.resource.data.title.size() <= 50
        && request.resource.data.price is number
        && request.resource.data.price >= 0;

      // 수정: 판매자 본인 또는 관리자
      // 단, views / likeCount / chatCount / likedBy 는 다른 사용자도 업데이트 가능
      allow update: if isLoggedIn() && (
        // 관리자: 모든 필드 수정 가능
        isAdmin()
        ||
        // 판매자 본인: 모든 필드 수정 가능
        resource.data.sellerId == request.auth.uid
        ||
        // 다른 사용자: views, likeCount, chatCount, likedBy 필드만 허용
        (
          request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(['views', 'likeCount', 'chatCount', 'likedBy'])
        )
      );

      // 삭제: 판매자 본인 또는 관리자
      allow delete: if isLoggedIn()
        && (resource.data.sellerId == request.auth.uid || isAdmin());
    }


    // ========== users 컬렉션 ==========
    match /users/{userId} {

      // 읽기: 로그인한 사용자 또는 관리자
      allow read: if isLoggedIn();

      // 생성/수정: 본인 또는 관리자 (관리자는 banned 처리 등 가능)
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || isAdmin();

      // 삭제: 본인만
      allow delete: if isOwner(userId);
    }


    // ========== chats 컬렉션 ==========
    match /chats/{chatId} {

      // 읽기: 채팅 참여자(buyerId 또는 sellerId)만 가능
      allow read: if isLoggedIn()
        && (
          resource.data.buyerId == request.auth.uid
          || resource.data.sellerId == request.auth.uid
        );

      // 생성: 로그인한 사용자만, 본인이 buyerId여야 함
      allow create: if isLoggedIn()
        && request.resource.data.buyerId == request.auth.uid;

      // 수정: 채팅 참여자만 (메시지 추가, 읽음 처리 등)
      allow update: if isLoggedIn()
        && (
          resource.data.buyerId == request.auth.uid
          || resource.data.sellerId == request.auth.uid
        );

      // 삭제: 불가 (채팅 기록 보존)
      allow delete: if false;
    }


    // ========== reports 컬렉션 ==========
    match /reports/{reportId} {

      // 읽기: 관리자만
      allow read: if isAdmin();

      // 신고 생성: 로그인한 사용자만, 본인 uid 포함
      allow create: if isLoggedIn()
        && request.resource.data.reporterId == request.auth.uid;

      // 수정(처리완료 등): 관리자만
      allow update: if isAdmin();

      // 삭제: 불가
      allow delete: if false;
    }


    // ========== inquiries 컬렉션 ==========
    match /inquiries/{inquiryId} {

      // 읽기: 관리자만
      allow read: if isAdmin();

      // 문의 생성: 누구나 가능 (비로그인 사용자도 문의 가능)
      allow create: if request.resource.data.name is string
        && request.resource.data.name.size() > 0
        && request.resource.data.email is string
        && request.resource.data.email.size() > 0
        && request.resource.data.type is string
        && request.resource.data.type.size() > 0
        && request.resource.data.title is string
        && request.resource.data.title.size() > 0
        && request.resource.data.content is string
        && request.resource.data.content.size() > 0
        && request.resource.data.content.size() <= 1000;

      // 수정(답변 처리 등): 관리자만
      allow update: if isAdmin();

      // 삭제: 불가
      allow delete: if false;
    }

  }
}
